=====================================================================
                      STM32-P207(GCC)ターゲット依存部 
=====================================================================

(1) 対応しているターゲットシステムの種類・構成

STM32-P207(GCC)ターゲット依存部は，STM32F207ZET6(Cortex-M3)を搭載した
OLIMEX社のSTM32-P207ボードをサポートする．プロセッサ依存部として
ST32F(GCC)プロセッサ依存部を，プロセッサ依存部としてARM_Mプロセッサ
依存部をそれぞれ使用する．


(2) 使用する開発環境と動作検証した条件（バージョン，オプション等）

・コンパイラ

GCC 4.4.1  (Sourcery G++ Lite 2010q1-188) で動作確認を行った．

・デバッグ環境

デバッグ環境としては，JTAGデバッガにST-Link，デバッガとしてuVisionを用
いた環境で動作確認を行っている．

動作確認した uVision は以下のバージョンである．

    V4.53.0.0

(3) ターゲット定義事項の規定

(4) メモリマップ

標準
　内蔵FlashROM
  ・アドレス : 0x08000000
  ・サイズ   : 512KB
  ・配置セクション
   ・vectorセクション（FLASHの先頭）
   ・textセクション
   ・rodataセクション
   
  内蔵RAM
  ・アドレス : 0x20000000
  ・サイズ   : 112KB
    ・dataセクション
    ・bssセクション
    
  0x0番地にFLASHの先頭番地がリマップされている．
  つまり，0x0番地にリセット時のMSP，0x4番地にリセット
  ベクタがそれぞれ配置される．

(5) シリアルインタフェースドライバの情報

コンソール出力には，USARTのチャネル6を用いる．通信フォーマットは以下の
通りである．

  ・1152200bps, Data 8bit, Parity none, Stop 1bit, Flow control none

(6) システムログ機能の情報

システムログの低レベル出力は，UART6を用いる．通信フォーマットは，
115200bps, 8bit, non-parity, 1topbitである．

(7) メモリ保護機能について

(7-1) サポートするメモリリージョン

・FLASH（TA_STDROM）
・SRAM（TA_STDRAM）

(7-2) サポートする標準のセクション

・.text
  FLASHに配置され，属する保護ドメインからの読込みと実行が可能
・.rodata
  FLASHに配置され，属する保護ドメインからの読込みと実行が可能
・.data
  SRAMに配置され，属する保護ドメインからの読込みと書込みと実行が可能
・.bss
  SRAMに配置され，属する保護ドメインからの読込みと書込みと実行が可能

(7-3) メモリオブジェクト属性

ARM Cortex-M3のMPUでは，各領域に設定可能なアクセス権として，以下のもの
がある．
・アクセス禁止
・特権モードで読込みと書込みが可能
・ユーザモードでは読込み，特権モードでは読込みと書込みがそれぞれ可能
・ユーザモードと特権モードで読込みと書込みが可能
・特権モードで読込みが可能
・ユーザモードと特権モードで読込みが可能
さらに，上記の各アクセスについて，実行が可能かどうかを設定可能である．
よって，設定可能なアクセス権は，12通りある．
また，各領域をキャッシング可能かどうかを選択可能である．

しかし，ARM Cortex-M3のMPUには，設定可能な領域が8つしか存在しないため，
上記すべてのアクセス権をサポートすることはできない．

そこで，本ターゲットでサポートするメモリオブジェクトに対するアクセス権は，
以下の5通りとする．
・属する保護ドメインから読出しと実行が可能
・属する保護ドメインから読出しと書込みと実行が可能
・すべての保護ドメインから読出しと実行が可能
・すべての保護ドメインから読出しと書込みと実行が可能
・すべての保護ドメインから読出しと実行が可能で，属する保護ドメインから
  読出しと書込みと実行が可能
各アクセス権に対し，キャッシングが可能かどうかは選択可能であるが，
各アクセス権について，キャッシング可能な領域とキャッシングが不可な領域を
ともに設定することはできない．

よって，本ターゲットでは，以下のようにメモリオブジェクト属性を扱う．
・TA_NOWRITEが指定された場合，書込みアクセスを禁止する．
・TA_NOREADとTA_EXECの指定は無視する．
・TA_MEMINI，TA_MEMPRSVの指定はターゲット非依存部で処理する．
・TA_SDATAの指定は無視する（ショートデータ領域はサポートしない）．
・TA_UNCACHEが指定された場合，キャッシング無効とする．
・TA_IODEVの指定は無視する．

また，ATT_MEMによって登録されるメモリオブジェクトは，各保護ドメインにつき，
1つまでサポートする．
ただし，ATT_MEMによって登録されたメモリオブジェクトが，無所属の場合には，
他のメモリオブジェクトをATT_MEMで登録することはできない．
これは，ATT_MEMを実現するためのMPUの領域数が1つしかないためである．

(7-4) 例外ハンドラ

MPUに関連する例外が発生した時に呼ばれる例外ハンドラは，以下のとおりである．

・メモリ保護違反例外ハンドラ
  void target_mpu_exc_handler(void *p_excinf);

また，タスク例外呼出し，または，リターン時に呼ばれる，エミュレートされた
例外ハンドラと使用する例外番号は，以下のとおりである．

・タスク例外実行開始時スタック不正ハンドラ
  void target_emulate_texrtn_handler(void *p_excinf);
  EXCNO_EMU_TEXRTN    0x07
・タスク例外リターン時スタック不正ハンドラ
  void target_emulate_ret_tex_handler(void *p_excinf);
  EXCNO_EMU_RET_TEX   0x08

(7-5) メモリ保護機能の脆弱性

本ターゲットでは，MPUの領域サイズ制約と領域の先頭番地アライメント制約を
満たしつつ，メモリの使用量を効率化するよう，プログラムのコードやデータを
メモリ上に配置する．そのため，あるタスクに割り当てられたユーザスタック
領域が，そのタスクが属する保護ドメインからアクセス可能なメモリ領域に
連続して配置される可能性がある．この場合，ユーザスタックの溢れを検知
することができず，メモリ保護機能が完全でないものとなる．
このメモリ保護機能の脆弱性を解消する方法については，今後の課題である．

(8) ディレクトリ構成・ファイル構成
  ./stm32p207_gcc
    ./E_PACKAGE
    ./Makefile.target
    ./MANIFEST
    ./stm32p207.h
    ./stm32p207_ram.ld
    ./stm32p207_rom.ld
    ./target.tf
    ./target_asm.inc
    ./target_cfg1_out.h
    ./target_config.c
    ./target_config.h
    ./target_def.csv
    ./target_kernel.h
    ./target_mem.cfg
    ./target_mem.h
    ./target_mem.tf
    ./target_mpu.h
    ./target_offset.tf
    ./target_opt.tf
    ./target_rename.def
    ./target_rename.h
    ./target_serial.cfg
    ./target_serial.h
    ./target_sil.h
    ./target_stddef.h
    ./target_support.S
    ./target_svc.h
    ./target_syssvc.h
    ./target_test.h
    ./target_timer.c
    ./target_timer.cfg
    ./target_timer.h
    ./target_unrename.h
    ./target_user.txt

(9)変更履歴

2012/12/27
・Release 2.1.0対応
・ATT_MEM，および，ユーザ指定のユーザスタック領域のサポート
・いくつかのバグ修正

2012/08/08
・新規作成

以上．
